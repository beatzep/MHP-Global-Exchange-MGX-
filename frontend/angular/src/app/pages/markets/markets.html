<div class="page-container">
  <div class="markets-header">
    <div class="header-content">
      <h2>M√§rkte</h2>
      <p class="subtitle">Live-Kursdaten aus verschiedenen Anlageklassen</p>
    </div>
    <div class="market-stats">
      <div class="stat-badge balance-badge">
        <span class="stat-label">Verf√ºgbar:</span>
        <span class="balance-amount">{{ (balance$ | async) | currency:'EUR':'symbol':'1.2-2' }}</span>
      </div>
      <div class="stat-badge">
        <span class="stat-label">Live</span>
        <span class="live-indicator"></span>
      </div>
      <div class="stat-badge">
        <span class="stat-label">Aktualisiert alle 60s</span>
      </div>
    </div>
  </div>

  <!-- Category Navigation Bar -->
  <div class="category-bar">
    <button
      class="category-btn"
      [class.active]="selectedCategory === 'stocks'"
      (click)="selectCategory('stocks')">
      <span class="category-icon">üìà</span>
      <span class="category-label">Aktien</span>
      <span class="category-count">10</span>
    </button>
    <button
      class="category-btn"
      [class.active]="selectedCategory === 'etfs'"
      (click)="selectCategory('etfs')">
      <span class="category-icon">üìä</span>
      <span class="category-label">ETFs</span>
      <span class="category-count">8</span>
    </button>
    <button
      class="category-btn"
      [class.active]="selectedCategory === 'bonds'"
      (click)="selectCategory('bonds')">
      <span class="category-icon">üíº</span>
      <span class="category-label">Anleihen</span>
      <span class="category-count">8</span>
    </button>
  </div>

  <!-- Loading State -->
  <div class="markets-grid" *ngIf="!(marketData$ | async)?.length">
    <div class="market-card skeleton" *ngFor="let i of [1,2,3,4,5,6]">
      <div class="skeleton-line"></div>
      <div class="skeleton-line short"></div>
      <div class="skeleton-line"></div>
    </div>
  </div>

  <!-- Market Data Grid -->
  <div class="markets-grid" *ngIf="(marketData$ | async)?.length">
    <div class="market-card" *ngFor="let data of marketData$ | async">
      <div class="card-header">
        <div class="symbol-info">
          <h3 class="symbol">{{ data.symbol }}</h3>
          <span class="company-name">{{ getCompanyName(data.symbol) }}</span>
        </div>
        <div class="change-badge" [ngClass]="getChangeClass(data.change)">
          <span class="change-icon">{{ getChangeIcon(data.change) }}</span>
        </div>
      </div>

      <div class="card-body">
        <div class="price-section">
          <div class="current-price">{{ data.price | currency:'USD':'symbol':'1.2-2' }}</div>
          <div class="price-change" [ngClass]="getChangeClass(data.change)">
            <span class="change-value">{{ data.change >= 0 ? '+' : '' }}{{ data.change | number:'1.2-2' }}</span>
            <span class="change-percent">({{ data.changePercent | number:'1.2-2' }}%)</span>
          </div>
        </div>

        <div class="card-footer">
          <button
            class="watchlist-toggle-btn"
            [class.in-watchlist]="isInWatchlist(data.symbol)"
            (click)="toggleWatchlist(data.symbol, $event)"
            [title]="isInWatchlist(data.symbol) ? 'Aus Watchlist entfernen' : 'Zur Watchlist hinzuf√ºgen'">
            <span class="watchlist-icon">{{ isInWatchlist(data.symbol) ? '‚òÖ' : '‚òÜ' }}</span>
          </button>
          <button class="buy-btn" (click)="openBuyModal(data, $event)">Kaufen</button>
          <button class="view-details-btn" (click)="showChart(data)">Details</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Section -->
  <div class="info-banner">
    <span class="info-icon">‚ÑπÔ∏è</span>
    <p>Die Kursdaten werden von Finnhub bereitgestellt und alle 60 Sekunden aktualisiert. F√ºr Echtzeit-Trading bitte einloggen.</p>
  </div>

  <!-- Chart Modal -->
  <div *ngIf="selectedStock" class="modal-overlay" (click)="closeChart()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <h2>{{ selectedStock.symbol }}</h2>
          <span class="modal-subtitle">{{ getCompanyName(selectedStock.symbol) }}</span>
        </div>
        <button class="close-button" (click)="closeChart()">√ó</button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="chartData.length > 0; else chartLoading">
          <app-stock-chart-home [chartData]="chartData" [colorScheme]="chartColorScheme"></app-stock-chart-home>
        </ng-container>
        <ng-template #chartLoading>
          <div class="chart-loading">
            <div class="loading-spinner"></div>
            <p>Lade Chart-Daten...</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Buy Modal -->
  <div *ngIf="showBuyModal" class="modal-overlay" (click)="closeBuyModal()">
    <div class="buy-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <h2>{{ selectedAssetForBuy?.symbol }} kaufen</h2>
          <span class="modal-subtitle">{{ getCompanyName(selectedAssetForBuy?.symbol || '') }}</span>
        </div>
        <button class="close-button" (click)="closeBuyModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="buy-form">
          <div class="form-row">
            <label>Aktueller Preis</label>
            <div class="price-display">{{ selectedAssetForBuy?.price | currency:'USD':'symbol':'1.2-2' }}</div>
          </div>

          <div class="form-row">
            <label for="quantity">Anzahl</label>
            <input
              type="number"
              id="quantity"
              [(ngModel)]="buyQuantity"
              min="1"
              step="1"
              class="quantity-input">
          </div>

          <div class="cost-breakdown">
            <div class="cost-row">
              <span>Wertpapiere</span>
              <span>{{ (selectedAssetForBuy?.price || 0) * buyQuantity | currency:'USD':'symbol':'1.2-2' }}</span>
            </div>
            <div class="cost-row">
              <span>Geb√ºhren</span>
              <span>{{ calculateFees() | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
            <div class="cost-row total">
              <span>Gesamtkosten</span>
              <span>{{ calculateTotalCost() | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
            <div class="cost-row balance-info">
              <span>Verf√ºgbar</span>
              <span>{{ (balance$ | async) | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>

          <div class="modal-actions">
            <button class="cancel-btn" (click)="closeBuyModal()">Abbrechen</button>
            <button
              class="confirm-buy-btn"
              (click)="confirmPurchase()"
              [disabled]="calculateTotalCost() > ((balance$ | async) || 0)">
              Jetzt kaufen
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
